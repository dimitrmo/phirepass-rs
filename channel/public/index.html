<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
        <link rel="stylesheet" href="xterm.css" />
        <link rel="stylesheet" href="phirepass.css" />
        <style>
            /* Minimal styling for the SFTP panel without touching the shared stylesheet */
            #sftp-panel {
                margin-top: 22px;
                padding-top: 12px;
                border-top: 1px solid rgba(255, 255, 255, 0.06);
            }

            #sftp-head {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 12px;
                margin-bottom: 8px;
            }

            #sftp-head h2 {
                margin: 0;
                font-size: 18px;
            }

            .pill {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 8px 12px;
                border-radius: 999px;
                background: rgba(59, 130, 246, 0.12);
                color: #bfdbfe;
                font-weight: 600;
                font-size: 13px;
            }

            .pill.ok {
                background: rgba(34, 197, 94, 0.18);
                color: #bbf7d0;
            }

            .pill.warn {
                background: rgba(234, 179, 8, 0.16);
                color: #fde68a;
            }

            .pill.error {
                background: rgba(239, 68, 68, 0.18);
                color: #fecdd3;
            }

            #sftp-nodes {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 10px;
                margin: 10px 0;
            }

            .sftp-meta {
                color: #cbd5e1;
                font-size: 12px;
            }

            #sftp-log,
            #sftp-output {
                background: rgba(15, 23, 42, 0.72);
                border: 1px solid rgba(255, 255, 255, 0.06);
                border-radius: 10px;
                padding: 10px;
                font-family: "JetBrains Mono", "SFMono-Regular", Consolas,
                    monospace;
                font-size: 13px;
            }

            #sftp-log {
                max-height: 120px;
                overflow-y: auto;
                margin-bottom: 10px;
            }

            #sftp-output {
                min-height: 180px;
                max-height: 360px;
                overflow-y: auto;
                white-space: pre-wrap;
            }

            #sftp-controls {
                display: flex;
                align-items: center;
                gap: 8px;
                margin: 8px 0;
            }

            #sftp-credentials {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 8px;
                margin: 10px 0;
            }

            #sftp-credentials label {
                display: flex;
                flex-direction: column;
                gap: 4px;
                font-size: 13px;
                color: #cbd5e1;
            }

            #sftp-credentials input {
                padding: 8px;
                border-radius: 8px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                background: rgba(255, 255, 255, 0.04);
                color: #e5e7eb;
            }

            #sftp-command-row {
                display: flex;
                gap: 8px;
                margin: 10px 0;
            }

            #sftp-command {
                flex: 1;
                padding: 9px 10px;
                border-radius: 10px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                background: rgba(255, 255, 255, 0.04);
                color: #e5e7eb;
            }
        </style>
        <title>WASM Example</title>
    </head>
    <body>
        <main>
            <header>
                <div>
                    <h1>Phirepass Console</h1>
                    <div style="color: #94a3b8; font-size: 14px">
                        xterm.js websocket bridge to /api/web/ws
                    </div>
                </div>
                <div
                    style="display: inline-flex; align-items: center; gap: 8px"
                >
                    <div id="status">Idle</div>
                    <button id="connect" disabled>Connect</button>
                    <button id="fullscreen">Fullscreen</button>
                </div>
            </header>
            <div
                style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 6px;
                    gap: 12px;
                "
            >
                <div style="font-weight: 600; color: #cbd5e1">Nodes</div>
                <button id="refresh-nodes">Refresh</button>
            </div>
            <div id="nodes"></div>
            <div id="log" aria-live="polite"></div>
            <div id="terminal"></div>
            <section id="sftp-panel" aria-labelledby="sftp-title">
                <div id="sftp-head">
                    <div>
                        <h2 id="sftp-title">Web SFTP</h2>
                        <div style="color: #94a3b8; font-size: 14px">
                            Connect to a node and browse files over SFTP
                        </div>
                    </div>
                    <div style="display: inline-flex; gap: 8px; align-items: center">
                        <div id="sftp-status" class="pill">Idle</div>
                        <button id="sftp-refresh">Refresh</button>
                        <button id="sftp-disconnect" disabled>Disconnect</button>
                    </div>
                </div>
                <div
                    style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin: 6px 0 4px 0;
                        gap: 10px;
                    "
                >
                    <div style="font-weight: 600; color: #cbd5e1">
                        Nodes
                    </div>
                    <div style="color: #94a3b8; font-size: 13px">
                        Click a node to open an SFTP tunnel
                    </div>
                </div>
                <div id="sftp-nodes"></div>
                <div id="sftp-controls" aria-live="polite">
                    <div style="color: #94a3b8; font-size: 13px">
                        Provide credentials if requested.
                    </div>
                </div>
                <div id="sftp-credentials" hidden>
                    <label>
                        Username
                        <input id="sftp-username" autocomplete="username" />
                    </label>
                    <label>
                        Password
                        <input
                            id="sftp-password"
                            type="password"
                            autocomplete="current-password"
                        />
                    </label>
                    <div style="display: flex; gap: 8px; align-items: flex-end">
                        <button id="sftp-submit">Submit</button>
                        <button id="sftp-cancel" type="button">Cancel</button>
                    </div>
                </div>
                <div id="sftp-log" aria-live="polite"></div>
                <div id="sftp-client" hidden>
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            gap: 8px;
                        "
                    >
                        <div style="color: #cbd5e1; font-weight: 600">
                            SFTP session
                        </div>
                        <div style="color: #94a3b8; font-size: 13px">
                            Send SFTP commands (e.g. ls, pwd, get, put).
                        </div>
                    </div>
                    <div id="sftp-command-row">
                        <input
                            id="sftp-command"
                            placeholder="Type an SFTP command..."
                            aria-label="SFTP command"
                        />
                        <button id="sftp-send">Send</button>
                    </div>
                    <div id="sftp-output" aria-live="polite"></div>
                </div>
            </section>
        </main>
        <script src="xterm.min.js"></script>
        <script src="xterm-addon-fit.js"></script>
        <script type="module">
            import init, {
                Protocol,
                ErrorType,
            } from "/pkg/debug/phirepass-channel.js";

            const wsScheme =
                window.location.protocol === "https:" ? "wss" : "ws";
            const wsEndpoint = `${wsScheme}://${window.location.hostname}:8080/api/web/ws`;
            const httpEndpoint = `${window.location.protocol}//${window.location.hostname}:8080`;

            const sftpStatus = document.getElementById("sftp-status");
            const sftpNodes = document.getElementById("sftp-nodes");
            const sftpLog = document.getElementById("sftp-log");
            const sftpClient = document.getElementById("sftp-client");
            const sftpOutput = document.getElementById("sftp-output");
            const sftpCmdInput = document.getElementById("sftp-command");
            const sftpSendBtn = document.getElementById("sftp-send");
            const sftpRefreshBtn = document.getElementById("sftp-refresh");
            const sftpDisconnectBtn = document.getElementById("sftp-disconnect");
            const sftpCreds = document.getElementById("sftp-credentials");
            const sftpUsername = document.getElementById("sftp-username");
            const sftpPassword = document.getElementById("sftp-password");
            const sftpSubmit = document.getElementById("sftp-submit");
            const sftpCancel = document.getElementById("sftp-cancel");

            const encoder = new TextEncoder();
            const decoder = new TextDecoder();

            let sftpSocket = null;
            let heartbeat = null;
            let selectedSftpNode = null;
            let credentialMode = null; // "username" | "password"
            let cachedUsername = "";
            let cachedPassword = "";
            let hasSftpData = false;

            const logSftp = (text) => {
                const line = document.createElement("div");
                line.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
                sftpLog.appendChild(line);
                sftpLog.scrollTop = sftpLog.scrollHeight;
            };

            const setSftpStatus = (text, variant = "info") => {
                sftpStatus.textContent = text;
                sftpStatus.className = `pill ${
                    variant === "ok"
                        ? "ok"
                        : variant === "warn"
                        ? "warn"
                        : variant === "error"
                        ? "error"
                        : ""
                }`.trim();
            };

            const encodeFrame = (protocol, payload) => {
                const buffer = new Uint8Array(5 + payload.length);
                buffer[0] = protocol;
                const view = new DataView(buffer.buffer);
                view.setUint32(1, payload.length);
                buffer.set(payload, 5);
                return buffer;
            };

            const sendControl = (message) => {
                if (!sftpSocket || sftpSocket.readyState !== WebSocket.OPEN) {
                    return;
                }
                const payload = encoder.encode(JSON.stringify(message));
                sftpSocket.send(encodeFrame(Protocol.Control, payload));
            };

            const sendSftpData = (text) => {
                if (!selectedSftpNode || !text.trim()) return;
                const data = Array.from(encoder.encode(text));
                const payload = encoder.encode(
                    JSON.stringify({
                        type: "TunnelData",
                        protocol: Protocol.SFTP,
                        target: selectedSftpNode,
                        data,
                    })
                );
                sftpSocket?.send(encodeFrame(Protocol.Control, payload));
            };

            const openTunnel = (withCredentials = false) => {
                if (!selectedSftpNode || !sftpSocket) return;
                const message = {
                    type: "OpenTunnel",
                    protocol: Protocol.SFTP,
                    target: selectedSftpNode,
                };
                if (withCredentials) {
                    if (cachedUsername) message.username = cachedUsername;
                    if (cachedPassword) message.password = cachedPassword;
                }
                sendControl(message);
            };

            const stopHeartbeat = () => {
                if (heartbeat) {
                    clearInterval(heartbeat);
                    heartbeat = null;
                }
            };

            const teardown = () => {
                stopHeartbeat();
                if (sftpSocket) {
                    sftpSocket.close();
                    sftpSocket = null;
                }
                credentialMode = null;
                sftpCreds.hidden = true;
                sftpClient.hidden = true;
                hasSftpData = false;
                setSftpStatus("Idle");
                sftpDisconnectBtn.disabled = true;
            };

            const requestCredentials = (mode) => {
                credentialMode = mode;
                sftpCreds.hidden = false;
                if (mode === "username") {
                    sftpPassword.value = "";
                    sftpUsername.focus();
                } else if (mode === "password") {
                    sftpPassword.value = "";
                    sftpPassword.focus();
                }
            };

            const handleControlFrame = (message) => {
                if (!message || !message.type) return;
                switch (message.type) {
                    case "Error":
                        switch (message.kind) {
                            case ErrorType.RequiresUsernamePassword:
                                setSftpStatus("Credentials required", "warn");
                                logSftp("Server requested username and password.");
                                requestCredentials("username");
                                break;
                            case ErrorType.RequiresPassword:
                                setSftpStatus("Password required", "warn");
                                logSftp("Server requested password.");
                                requestCredentials("password");
                                break;
                            default:
                                setSftpStatus("Auth error", "error");
                                logSftp(
                                    message.message ||
                                        "SFTP authentication failed."
                                );
                                requestCredentials("username");
                        }
                        break;
                    case "TunnelClosed":
                        setSftpStatus("Tunnel closed", "warn");
                        logSftp("SFTP tunnel closed by remote host.");
                        teardown();
                        break;
                    default:
                        if (message.message) {
                            logSftp(message.message);
                        }
                        break;
                }
            };

            const handleSftpFrame = (payload) => {
                if (!hasSftpData) {
                    hasSftpData = true;
                    sftpClient.hidden = false;
                    setSftpStatus("SFTP active", "ok");
                }
                let text;
                try {
                    text = decoder.decode(payload);
                } catch (err) {
                    text = `Received ${payload.byteLength} bytes`;
                }
                const line = document.createElement("div");
                line.textContent = text;
                sftpOutput.appendChild(line);
                sftpOutput.scrollTop = sftpOutput.scrollHeight;
            };

            const connectSftp = () => {
                if (!selectedSftpNode) {
                    logSftp("Select a node before opening SFTP.");
                    return;
                }

                teardown();
                setSftpStatus("Connecting...");
                logSftp(`Connecting to ${selectedSftpNode} via SFTP...`);

                sftpSocket = new WebSocket(wsEndpoint);
                sftpSocket.binaryType = "arraybuffer";

                sftpSocket.addEventListener("open", () => {
                    setSftpStatus("Socket open", "info");
                    sendControl({ type: "Heartbeat" });
                    heartbeat = setInterval(
                        () => sendControl({ type: "Heartbeat" }),
                        15000
                    );
                    openTunnel(Boolean(cachedUsername || cachedPassword));
                    sftpDisconnectBtn.disabled = false;
                });

                sftpSocket.addEventListener("message", (event) => {
                    if (typeof event.data === "string") {
                        logSftp(event.data);
                        return;
                    }

                    const data = new Uint8Array(event.data);
                    if (data.length < 5) return;
                    const protocol = data[0];
                    const view = new DataView(
                        data.buffer,
                        data.byteOffset,
                        data.byteLength
                    );
                    const len = view.getUint32(1);
                    if (data.length < 5 + len) return;
                    const payload = data.slice(5, 5 + len);

                    if (protocol === Protocol.Control) {
                        try {
                            const text = decoder.decode(payload);
                            const message = JSON.parse(text);
                            handleControlFrame(message);
                        } catch (err) {
                            console.warn("Failed to parse control frame", err);
                        }
                        return;
                    }

                    if (protocol === Protocol.SFTP) {
                        handleSftpFrame(payload);
                    }
                });

                sftpSocket.addEventListener("error", (event) => {
                    setSftpStatus("Error", "error");
                    logSftp(`Socket error: ${event.message ?? "unknown"}`);
                });

                sftpSocket.addEventListener("close", () => {
                    setSftpStatus("Disconnected", "warn");
                    logSftp("SFTP websocket closed.");
                    teardown();
                });
            };

            const renderNodes = (list) => {
                sftpNodes.innerHTML = "";
                if (!list.length) {
                    const empty = document.createElement("div");
                    empty.style.color = "#94a3b8";
                    empty.textContent = "No nodes connected.";
                    sftpNodes.appendChild(empty);
                    return;
                }

                list.forEach((node) => {
                    const card = document.createElement("div");
                    card.className = "node-card";
                    card.dataset.nodeId = node.id;

                    const name = document.createElement("div");
                    name.className = "node-name";
                    name.textContent = node.id;
                    card.appendChild(name);

                    const meta = document.createElement("div");
                    meta.className = "sftp-meta";
                    meta.innerHTML = [
                        `ip: ${node.ip}`,
                        `uptime: ${(
                            (node.connected_for_secs || 0) / 60
                        ).toFixed(1)} min`,
                        `last hb: ${(
                            node.since_last_heartbeat_secs || 0
                        ).toFixed(1)}s`,
                    ]
                        .map((line) => `<div>${line}</div>`)
                        .join("");
                    card.appendChild(meta);

                    card.addEventListener("click", () => {
                        selectedSftpNode = node.id;
                        Array.from(sftpNodes.children).forEach((el) =>
                            el.classList.toggle(
                                "selected",
                                el.dataset.nodeId === node.id
                            )
                        );
                        connectSftp();
                    });

                    sftpNodes.appendChild(card);
                });
            };

            const fetchNodes = async () => {
                try {
                    const res = await fetch(`${httpEndpoint}/api/nodes`);
                    if (!res.ok) {
                        logSftp("Failed to fetch nodes");
                        return;
                    }
                    const list = await res.json();
                    renderNodes(list);
                } catch (err) {
                    logSftp(`Failed to fetch nodes: ${err.message}`);
                }
            };

            document.addEventListener("DOMContentLoaded", async () => {
                await init();
                fetchNodes();

                sftpSendBtn.addEventListener("click", () => {
                    const command = sftpCmdInput.value.trim();
                    if (!command) return;
                    sendSftpData(`${command}\n`);
                    sftpCmdInput.value = "";
                });

                sftpCmdInput.addEventListener("keydown", (event) => {
                    if (event.key === "Enter") {
                        event.preventDefault();
                        sftpSendBtn.click();
                    }
                });

                sftpRefreshBtn.addEventListener("click", fetchNodes);

                sftpDisconnectBtn.addEventListener("click", () => {
                    logSftp("Disconnecting SFTP session...");
                    teardown();
                });

                sftpSubmit.addEventListener("click", () => {
                    cachedUsername = sftpUsername.value.trim();
                    cachedPassword = sftpPassword.value;
                    sftpCreds.hidden = true;
                    setSftpStatus("Authenticating...", "info");
                    openTunnel(true);
                });

                sftpCancel.addEventListener("click", () => {
                    credentialMode = null;
                    cachedPassword = "";
                    sftpCreds.hidden = true;
                    setSftpStatus("Idle", "warn");
                });
            });
        </script>
        <script type="module" src="phirepass.js"></script>
    </body>
</html>
